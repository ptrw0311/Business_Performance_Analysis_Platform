# Spec: KPI 和圖表面板

## ADDED Requirements

### Requirement: KPI 和圖表面板顯示位置
系統 SHALL 在「淨利率區塊」和「詳細財務數據表」之間插入新的 KPI 和圖表面板。

#### Scenario: 使用者查看公司財務分析頁面
**Given** 使用者選擇了一家公司（如「博弘雲端」）
**When** 財務資料載入完成
**Then** 頁面應依序顯示：
1. 公司選擇器
2. 統計卡片 (5年平均營收、淨利、淨利率)
3. 績效洞察面板
4. 財務圖表 (營收/淨利長條圖)
5. **淨利率區塊** (已存在)
6. **KPI 和圖表面板** (新增) ←
7. 詳細財務數據表 (已存在)

---

### Requirement: KPI 分析面板佈局
左側 KPI 區域 SHALL 佔據網頁 1/4 寬度，包含三個卡片區塊。

#### Scenario: 左側面板結構
**Given** KPI 和圖表面板已渲染
**When** 查看左側面板
**Then** 應顯示三個卡片，由上到下依序為：
1. **綜合分析評論 (EXECUTIVE SUMMARY)** - 保留空白，未來將使用 LLM 產出內容
2. **正面指標 (Positive)** - 列出表現良好的指標
3. **風險/關注指標 (Concern)** - 列出需要關注的指標

#### Scenario: 卡片樣式
**Given** 任一 KPI 卡片
**Then** 應包含：
- 卡片標題（帶圖示）
- 內容區域（文字或列表）
- 邊框和背景色與現有設計一致

---

### Requirement: 綜合分析評論保留空白
系統 SHALL 將「綜合分析評論 (EXECUTIVE SUMMARY)」卡片內容保留為空白。

> **未來規劃**: 此區塊將使用 LLM 產出財務分析內容

#### Scenario: 顯示空白卡片
**Given** 使用者查看 KPI 和圖表面板
**When** 查看「綜合分析評論 (EXECUTIVE SUMMARY)」卡片
**Then** 應顯示：
- 卡片標題「綜合分析評論 (EXECUTIVE SUMMARY)」
- 內容區域為空白（或顯示提示文字如「分析內容將由 AI 產生」）
- 卡片邊框和樣式與其他卡片一致

---

### Requirement: 正面指標識別
系統 SHALL 根據「財務分析指標.xlsx > 財務比率說明」的判斷邏輯自動識別並列出表現良好的財務指標。

#### Scenario: 識別正面指標 - 淨利率
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- 淨利率 > 10% (獲利能力優異)
- 前一年度<0%，本年度>0% (轉虧為盈)

#### Scenario: 識別正面指標 - 毛利率
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- 毛利率 > 10%
- 本年度毛利率 > 前一年度毛利率

#### Scenario: 識別正面指標 - ROA
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- ROA 連續三年皆呈現正成長

#### Scenario: 識別正面指標 - 償債能力
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- 流動比率 > 2
- 流動比率 > 1 且速動比率 > 0.8
- 前一年度流動比率 < 1，本年度 > 1 (改善)
- 速動比率 > 0.8
- 前一年度速動比率 < 0.8，本年度 > 0.8 (改善)
- 負債淨值比 < 100%

#### Scenario: 識別正面指標 - 經營效率
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- 應收帳款週轉率 > 6 次
- 存貨周轉率 > 4 次

#### Scenario: 識別正面指標 - 成長動能
**Given** 公司財務資料
**When** 計算正面指標
**Then** 以下條件應被列為正面指標：
- 營收成長率 > 10%
- 營收連續三年 > 10%
- 毛利成長率連續三年皆呈現正成長
- 毛利成長幅度超過 5%
- 稅前淨利成長率連續三年皆呈現正成長
- 稅前淨利成長幅度超過 5%

#### Scenario: 顯示正面指標
**Given** 有正面指標被識別
**When** 渲染正面指標卡片
**Then** 每個指標應顯示：
- 指標名稱
- 數值（帶單位）
- 綠色圖示（✓ 或向上箭頭）

---

### Requirement: 風險指標識別
系統 SHALL 根據「財務分析指標.xlsx > 財務比率說明」的判斷邏輯自動識別並列出需要關注的財務指標。

#### Scenario: 識別風險指標 - 獲利能力
**Given** 公司財務資料
**When** 計算風險指標
**Then** 以下條件應被列為風險指標：
- 淨利率 < 0% (虧損)
- 前一年度>0%，本年度<0% (轉盈為虧)
- 淨利率連續三年以上<0% (長期虧損)
- 毛利率 < 0%
- 本年度毛利率 < 前一年度毛利率
- ROA < 5%
- ROA < 0%

#### Scenario: 識別風險指標 - 償債能力
**Given** 公司財務資料
**When** 計算風險指標
**Then** 以下條件應被列為風險指標：
- 流動比率 < 1
- 前一年度流動比率 > 1，本年度 < 1 (惡化)
- 速動比率 < 0.8
- 前一年度速動比率 > 0.8，本年度 < 0.8 (惡化)
- 負債淨值比 > 200%
- 負債淨值比連續三年皆呈現正成長 (負債持續增加)

#### Scenario: 識別風險指標 - 經營效率
**Given** 公司財務資料
**When** 計算風險指標
**Then** 以下條件應被列為風險指標：
- 應收帳款週轉率 < 4 次
- 應收帳款週轉率連續三年皆呈現負成長
- 存貨周轉率 < 2 次
- 存貨周轉率連續三年皆呈現負成長

#### Scenario: 識別風險指標 - 成長動能
**Given** 公司財務資料
**When** 計算風險指標
**Then** 以下條件應被列為風險指標：
- 營收成長率 < 0%
- 營收連續三年 < 0%
- 毛利成長率連續三年皆呈現負成長
- 毛利衰退幅度超過 5%
- 稅前淨利成長率連續三年皆呈現負成長
- 稅前淨利衰退幅度超過 5%

#### Scenario: 識別風險指標 - 費用率
**Given** 公司財務資料
**When** 計算風險指標
**Then** 以下條件應被列為風險指標：
- 推銷費用占比 > 5%
- 推銷費用占比連續三年皆呈現正成長
- 推銷費用年增超過 3%
- 管理費用佔比 > 5%
- 管理費用佔比連續三年皆呈現正成長
- 管理費用年增超過 3%
- 研發費用佔比 > 5%
- 研發費用佔比連續三年皆呈現正成長
- 研發費用年增超過 3%

#### Scenario: 顯示風險指標
**Given** 有風險指標被識別
**When** 渲染風險指標卡片
**Then** 每個指標應顯示：
- 指標名稱
- 數值（帶單位）
- 紅色或橙色圖示（⚠ 或向下箭頭）

---

### Requirement: 圖表區域佈局
右側圖表區域 SHALL 佔據網頁 3/4 寬度，顯示 6 張圖表以 2x3 網格排列。

#### Scenario: 圖表網格排列
**Given** 圖表區域已渲染
**When** 查看右側面板
**Then** 應顯示 6 張圖表，排列如下：
```
┌─────────────┬─────────────┐
│ 獲利能力     │ 償債結構     │
├─────────────┼─────────────┤
│ 經營效率     │ 存貨週轉     │
├─────────────┼─────────────┤
│ 成長動能     │ 費用率趨勢   │
└─────────────┴─────────────┘
```

---

### Requirement: 獲利能力圖表
系統 SHALL 顯示淨利率、毛利率、ROA 的趨勢折線圖。

#### Scenario: 獲利能力圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染獲利能力圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：百分比 (0-100%)
- 3 條折線：淨利率、毛利率、ROA
- 圖例說明各線條代表意義

#### Scenario: 資料一致性
**Given** 獲利能力圖表已渲染
**Then** 圖表數值應與「詳細財務數據表」中對應年度的數值一致

---

### Requirement: 償債結構圖表
系統 SHALL 顯示流動比率、速動比率、負債淨值比的趨勢折線圖。

#### Scenario: 償債結構圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染償債結構圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：比率值（小數格式，如 1.75）
- 3 條折線：流動比率、速動比率、負債淨值比
- 資料需除以 100 後顯示

---

### Requirement: 經營效率圖表
系統 SHALL 顯示應收週轉率的混合圖（長條圖 + 折線圖）。

#### Scenario: 經營效率圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染經營效率圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：次數
- 長條圖顯示各年度應收週轉次數
- 折線圖顯示趨勢
- 單位標示：次

---

### Requirement: 存貨週轉圖表
系統 SHALL 顯示存貨周轉率的混合圖。

#### Scenario: 存貨週轉圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染存貨週轉圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：次數
- 長條圖顯示各年度存貨周轉次數
- 異常值（如 > 1000）應過濾或標註

---

### Requirement: 成長動能圖表
系統 SHALL 顯示營收成長率、毛利成長率、稅前淨利成長率的趨勢折線圖。

#### Scenario: 成長動能圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染成長動能圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：成長率百分比
- 3 條折線：營收成長率、毛利成長率、稅前淨利成長率
- 零度基準線
- 負值區域以不同顏色標示

#### Scenario: 成長率顏色區分
**Given** 成長動能圖表已渲染
**When** 查看圖表
**Then** 正成長應以綠色/藍色顯示，負成長應以紅色/橙色顯示

---

### Requirement: 費用率趨勢圖表
系統 SHALL 顯示推銷費用、管理費用、研發費用佔比的趨勢折線圖。

#### Scenario: 費用率趨勢圖表內容
**Given** 公司有 5 年財務資料
**When** 渲染費用率趨勢圖表
**Then** 應包含：
- X 軸：年度
- Y 軸：百分比 (0-100%)
- 3 條折線：推銷費用占比、管理費用佔比、研發費用佔比
- 圖例說明

---

### Requirement: 響應式設計
面板 SHALL 在不同螢幕尺寸下調整佈局。

#### Scenario: 桌面版 (>1024px)
**Given** 螢幕寬度 > 1024px
**When** 渲染 KPI 和圖表面板
**Then** 左右佈局，左側 25%，右側 75%，圖表 2x3 網格

#### Scenario: 平板版 (768px-1024px)
**Given** 螢幕寬度 768px-1024px
**When** 渲染 KPI 和圖表面板
**Then** 上下佈局，圖表 2 欄網格

#### Scenario: 手機版 (<768px)
**Given** 螢幕寬度 < 768px
**When** 渲染 KPI 和圖表面板
**Then** 上下佈局，圖表 1 欄網格

---

### Requirement: 資料來源
所有圖表和 KPI 分析的資料 SHALL 來自現有 API。

#### Scenario: 使用現有 API
**Given** KPI 和圖表面板需要財務指標資料
**When** 發送 API 請求
**Then** 應使用 `GET /api/financial/basics?company={companyName}`
**And** 不需要新增或修改 API

---

## MODIFIED Requirements

### Requirement: HomePage 組件結構
HomePage 組件 SHALL 在適當位置插入 KPI 和圖表面板。

#### Scenario: 插入新面板
**Given** HomePage 原本包含 FinanceChart 和 FinancialDataTable
**When** 修改 HomePage
**Then** 應在 FinanceChart 之後、FinancialDataTable 之前插入 KPIAndChartsSection
**And** 傳遞 `company` prop 給新組件

---

## REMOVED Requirements
無
