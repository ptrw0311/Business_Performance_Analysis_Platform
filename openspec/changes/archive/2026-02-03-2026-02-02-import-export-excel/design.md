# è¨­è¨ˆæ–‡ä»¶ï¼šExcel åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½

## ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‰ç«¯ (React)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  DataManagerTabs.jsx                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [è²¡å‹™å ±è¡¨] [æç›Šè¡¨]  [+ æ–°å¢] [ğŸ“¥ ExcelåŒ¯å…¥] [ğŸ“¤ ExcelåŒ¯å‡º]     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚              â”‚                            â”‚
â”‚                              â–¼              â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ExcelImportButton     â”‚  â”‚  ExcelExportButton     â”‚                â”‚
â”‚  â”‚  - æª”æ¡ˆé¸æ“‡å™¨           â”‚  â”‚  - ç¯„åœé¸æ“‡             â”‚                â”‚
â”‚  â”‚  - è§¸ç™¼ ImportPreview  â”‚  â”‚  - å‘¼å« Export API      â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚              â”‚                                                         â”‚
â”‚              â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ImportPreviewModal                            â”‚    â”‚
â”‚  â”‚  - é¡¯ç¤ºå°‡æ–°å¢/æ›´æ–°çš„ç­†æ•¸                                          â”‚    â”‚
â”‚  â”‚  - é¡¯ç¤ºç„¡æ³•å°æ‡‰çš„æ¬„ä½è­¦å‘Š                                         â”‚    â”‚
â”‚  â”‚  - ç¢ºèªå¾ŒåŸ·è¡ŒåŒ¯å…¥                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                         â”‚
â”‚                              â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       ImportResultToast                          â”‚    â”‚
â”‚  â”‚  - æˆåŠŸ/å¤±æ•—ç­†æ•¸é€šçŸ¥                                             â”‚    â”‚
â”‚  â”‚  - é‡æ–°æ•´ç†è¡¨æ ¼æŒ‰éˆ•                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTP API
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å¾Œç«¯ (Vercel Functions)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  /api/financial-basics/                                                  â”‚
â”‚  â”œâ”€â”€ POST /batch-import  â”€â”€â–º æ‰¹æ¬¡ Upsert financial_basics               â”‚
â”‚  â””â”€â”€ GET  /export         â”€â”€â–º ç”Ÿæˆ Excel ä¸¦ä¸‹è¼‰                         â”‚
â”‚                                                                          â”‚
â”‚  /api/pl-income/                                                          â”‚
â”‚  â”œâ”€â”€ POST /batch-import  â”€â”€â–º æ‰¹æ¬¡ Upsert pl_income_basics               â”‚
â”‚  â””â”€â”€ GET  /export         â”€â”€â–º ç”Ÿæˆ Excel ä¸¦ä¸‹è¼‰                         â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Supabase (PostgreSQL)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  financial_basics                â”‚  â”‚  pl_income_basics           â”‚  â”‚
â”‚  â”‚  - PK: (fiscal_year, tax_id)     â”‚  â”‚  - PK: (fiscal_year, tax_id)â”‚  â”‚
â”‚  â”‚  - 80+ æ¬„ä½                      â”‚  â”‚  - 26 æ¬„ä½                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¬„ä½å°æ‡‰æ©Ÿåˆ¶

### å°æ‡‰æµç¨‹åœ–

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Excel æª”æ¡ˆ    â”‚
                    â”‚  ç¬¬ 1 åˆ—ï¼šä¸­æ–‡  â”‚
                    â”‚  ç¬¬ 2 åˆ—ï¼šè‹±æ–‡  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ­¥é©Ÿ 1ï¼šè®€å–   â”‚
                    â”‚  Excel çµæ§‹     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ­¥é©Ÿ 2ï¼šä¸»è¦è¦å‰‡â”‚
                    â”‚  è‹±æ–‡åç¨± â†’      â”‚
                    â”‚  column_name     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ å°æ‡‰æˆåŠŸ       â”‚         â”‚ å°æ‡‰å¤±æ•—       â”‚
        â”‚ åŠ å…¥ mapping   â”‚         â”‚ å˜—è©¦æ¬¡è¦è¦å‰‡   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  æ­¥é©Ÿ 3ï¼šæ¬¡è¦è¦å‰‡â”‚
                                  â”‚  ä¸­æ–‡åç¨± â†’      â”‚
                                  â”‚  column_desc     â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                       â”‚
                               â–¼                       â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ å°æ‡‰æˆåŠŸ       â”‚       â”‚ å°æ‡‰å¤±æ•—       â”‚
                       â”‚ åŠ å…¥ mapping   â”‚       â”‚ è¨˜éŒ„è­¦å‘Š       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¨‹å¼ç¢¼ç¯„ä¾‹

```javascript
async function mapExcelColumns(excelHeaders, tableName) {
  // 1. å¾è³‡æ–™åº«å–å¾—æ¬„ä½è³‡è¨Š
  const columns = await db.query(`
    SELECT column_name, column_description
    FROM information_schema.columns
    WHERE table_name = $1
  `, [tableName]);

  // 2. å»ºç«‹å°æ‡‰è¡¨
  const mapping = new Map();
  const warnings = [];

  // ä¸»è¦è¦å‰‡ï¼šè‹±æ–‡åç¨± â†’ column_name
  excelHeaders.english.forEach((engName, index) => {
    const match = columns.find(col => col.column_name === engName);
    if (match) {
      mapping.set(match.column_name, index);
    }
  });

  // æ¬¡è¦è¦å‰‡ï¼šä¸­æ–‡åç¨± â†’ column_description
  excelHeaders.chinese.forEach((chiName, index) => {
    const match = columns.find(col => col.column_description === chiName);
    if (match && !mapping.has(match.column_name)) {
      mapping.set(match.column_name, index);
    }
  });

  return { mapping, warnings };
}
```

## Upsert é‚è¼¯

### æµç¨‹åœ–

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ”¶åˆ° Excel è³‡æ–™ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  é©—è­‰å¿…è¦æ¬„ä½    â”‚
                    â”‚  fiscal_year     â”‚
                    â”‚  tax_id          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ é©—è­‰é€šé       â”‚         â”‚ é©—è­‰å¤±æ•—       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æŸ¥è©¢è³‡æ–™åº«     â”‚         â”‚ è¨˜éŒ„éŒ¯èª¤       â”‚
        â”‚ PK æ˜¯å¦å­˜åœ¨    â”‚         â”‚ è·³éè©²ç­†       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚
        â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PK å­˜åœ¨       â”‚ â”‚ PK ä¸å­˜åœ¨     â”‚
â”‚ â†’ UPDATE      â”‚ â”‚ â†’ INSERT      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SQL å¯¦ä½œ

```sql
-- ä½¿ç”¨ INSERT ... ON CONFLICT é€²è¡Œ Upsert
INSERT INTO financial_basics (
  fiscal_year, tax_id, company_name, account_item,
  cash_equivalents, ar_net, ...
) VALUES (
  $1, $2, $3, $4, $5, $6, ...
)
ON CONFLICT (fiscal_year, tax_id)
DO UPDATE SET
  company_name = EXCLUDED.company_name,
  account_item = EXCLUDED.account_item,
  cash_equivalents = EXCLUDED.cash_equivalents,
  ar_net = EXCLUDED.ar_net,
  ...
  updated_at = NOW();
```

## åŒ¯å…¥é è¦½é‚è¼¯

### å…©éšæ®µåŒ¯å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éšæ®µä¸€ï¼šå‰ç«¯è§£æèˆ‡é è¦½                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. ä½¿ç”¨ XLSX.js åœ¨ç€è¦½å™¨ç«¯è§£æ Excel                                â”‚
â”‚  2. åŸ·è¡Œæ¬„ä½å°æ‡‰ï¼ˆæ¨¡æ“¬å¾Œç«¯é‚è¼¯ï¼‰                                      â”‚
â”‚  3. çµ±è¨ˆï¼š                                                          â”‚
â”‚     - å°‡æ–°å¢çš„ç­†æ•¸ï¼ˆPK ä¸å­˜åœ¨ï¼‰                                       â”‚
â”‚     - å°‡æ›´æ–°çš„ç­†æ•¸ï¼ˆPK å­˜åœ¨ï¼‰                                         â”‚
â”‚     - å¯èƒ½çš„éŒ¯èª¤                                                     â”‚
â”‚  4. é¡¯ç¤º ImportPreviewModal                                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼ ç¢ºèª
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éšæ®µäºŒï¼šå¾Œç«¯åŸ·è¡ŒåŒ¯å…¥                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. æ¥æ”¶å‰ç«¯è§£æå¾Œçš„è³‡æ–™                                             â”‚
â”‚  2. åŸ·è¡Œæ‰¹æ¬¡ Upsert                                                  â”‚
â”‚  3. å›å‚³å¯¦éš›åŸ·è¡Œçµæœ                                                 â”‚
â”‚  4. å‰ç«¯é¡¯ç¤º ImportResultToast                                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Excel æ¨£å¼è¨­è¨ˆ

### åŒ¯å‡ºæ ¼å¼è¦ç¯„

| å…ƒç´  | æ¨£å¼è¨­å®š |
|------|----------|
| ç¬¬ 1 åˆ—ï¼ˆä¸­æ–‡ï¼‰ | ç²—é«”ã€èƒŒæ™¯è‰² `#E8E8E8`ã€å­—å‹å¤§å° 12 |
| ç¬¬ 2 åˆ—ï¼ˆè‹±æ–‡ï¼‰ | ç°è‰²æ–‡å­—ã€å­—å‹å¤§å° 10ã€æ–œé«” |
| è³‡æ–™åˆ— | ä¸€èˆ¬æ–‡å­—ã€å­—å‹å¤§å° 11 |
| æ•¸å€¼æ¬„ä½ | åƒåˆ†ä½åˆ†éš”ã€ç„¡å°æ•¸ä½ |
| å‡çµçª—æ ¼ | å‡çµå‰ 2 åˆ— |

### ExcelJS å¯¦ä½œç¯„ä¾‹

```javascript
import ExcelJS from 'exceljs';

async function generateExcel(data, tableName) {
  const workbook = new ExcelJS.Workbook();
  const sheetName = tableName === 'financial_basics' ? 'è²¡å‹™å ±è¡¨' : 'æç›Šè¡¨';
  const sheet = workbook.addWorksheet(sheetName);

  // å–å¾—æ¬„ä½è³‡è¨Š
  const columns = await getTableColumns(tableName);

  // ç¬¬ 1 åˆ—ï¼šä¸­æ–‡æ¨™é¡Œ
  const headerRow1 = sheet.addRow(columns.map(c => c.column_description));
  headerRow1.font = { bold: true, size: 12 };
  headerRow1.fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FFE8E8E8' }
  };

  // ç¬¬ 2 åˆ—ï¼šè‹±æ–‡æ¨™é¡Œ
  const headerRow2 = sheet.addRow(columns.map(c => c.column_name));
  headerRow2.font = { italic: true, size: 10, color: { argb: 'FF808080' } };

  // è³‡æ–™åˆ—
  data.forEach(row => {
    sheet.addRow(columns.map(c => row[c.column_name] || ''));
  });

  // å‡çµå‰ 2 åˆ—
  sheet.views = [{ state: 'frozen', ySplit: 2 }];

  // è¨­å®šæ¬„å¯¬
  sheet.columns = columns.map(c => ({
    key: c.column_name,
    width: Math.max(c.column_name.length, c.column_description.length) + 2
  }));

  return workbook;
}
```

## éŒ¯èª¤è™•ç†ç­–ç•¥

### å‰ç«¯éŒ¯èª¤è™•ç†

```javascript
try {
  // è§£æ Excel
  const parsed = await parseExcelFile(file);

  // é¡¯ç¤ºé è¦½
  showPreview(parsed);
} catch (error) {
  if (error.code === 'INVALID_FILE_FORMAT') {
    showError('è«‹é¸æ“‡ .xlsx æ ¼å¼çš„æª”æ¡ˆ');
  } else if (error.code === 'MISSING_REQUIRED_SHEET') {
    showError('Excel æª”æ¡ˆç¼ºå°‘å¿…è¦çš„å·¥ä½œè¡¨');
  } else {
    showError('æª”æ¡ˆè§£æå¤±æ•—ï¼š' + error.message);
  }
}
```

### å¾Œç«¯éŒ¯èª¤è™•ç†

```javascript
export async function POST(request) {
  try {
    const { records } = await request.json();

    const results = {
      inserted: 0,
      updated: 0,
      skipped: 0,
      errors: []
    };

    for (const [index, record] of records.entries()) {
      // é©—è­‰å¿…è¦æ¬„ä½
      if (!record.fiscal_year || !record.tax_id) {
        results.skipped++;
        results.errors.push({
          row: index + 1,
          reason: 'ç¼ºå°‘å¿…è¦æ¬„ä½ fiscal_year æˆ– tax_id'
        });
        continue;
      }

      // åŸ·è¡Œ Upsert
      const result = await upsertRecord(record);
      if (result.action === 'insert') {
        results.inserted++;
      } else {
        results.updated++;
      }
    }

    return successResponse({ data: results });
  } catch (error) {
    return errorResponse('åŒ¯å…¥å¤±æ•—ï¼š' + error.message, 500);
  }
}
```

## æ•ˆèƒ½è€ƒé‡

### æ‰¹æ¬¡è™•ç†å„ªåŒ–

| å„ªåŒ–é …ç›® | èªªæ˜ |
|----------|------|
| æ‰¹æ¬¡ Insert | ä½¿ç”¨å–®ä¸€ SQL é™³è¿°å¼æ’å…¥å¤šç­†è¨˜éŒ„ |
| äº¤æ˜“è™•ç† | å°‡æ•´å€‹æ‰¹æ¬¡æ”¾åœ¨å–®ä¸€äº¤æ˜“ä¸­ |
| ä¸¦è¡Œè™•ç† | è²¡å‹™å ±è¡¨èˆ‡æç›Šè¡¨å¯ä¸¦è¡Œè™•ç† |

### æª”æ¡ˆå¤§å°é™åˆ¶

| é …ç›® | é™åˆ¶ |
|------|------|
| å–®æ¬¡åŒ¯å…¥ç­†æ•¸ | 1000 ç­† |
| æª”æ¡ˆå¤§å° | 10 MB |
| è¶…æ™‚æ™‚é–“ | 60 ç§’ï¼ˆVercel Proï¼‰ |

## å®‰å…¨æ€§è€ƒé‡

| é …ç›® | å¯¦ä½œæ–¹å¼ |
|------|----------|
| æª”æ¡ˆé¡å‹é©—è­‰ | åªæ¥å— .xlsx å‰¯æª”å |
| å…§å®¹é©—è­‰ | é©—è­‰ Sheet åç¨±ã€æ¬„ä½æ ¼å¼ |
| SQL Injection | ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ |
| æ¬Šé™æ§åˆ¶ | éœ€è¦ JWT é©—è­‰ |
| è®€å–å¤§å°é™åˆ¶ | é™åˆ¶ä¸Šå‚³æª”æ¡ˆå¤§å° |

## å¯¦ä½œç­†è¨˜

### 2026-02-03 ç·¨ç¢¼å•é¡Œä¿®æ­£

**å•é¡Œ**: Excel åŒ¯å…¥æ™‚ `company_name` å’Œ `account_item` æ¬„ä½å‡ºç¾äº‚ç¢¼ã€‚

**åŸå› **: XLSX.js é è¨­ä½¿ç”¨ `raw: true` æ¨¡å¼è®€å–è³‡æ–™ï¼Œå°è‡´ä¸­æ–‡å­—ä¸²ç·¨ç¢¼éŒ¯èª¤ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```javascript
// ä¿®æ”¹å‰
const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

// ä¿®æ”¹å¾Œ
const jsonData = XLSX.utils.sheet_to_json(sheet, {
  header: 1,
  raw: false,      // ç¢ºä¿ä¸­æ–‡å­—ä¸²æ­£ç¢ºè§£æ
  defval: null     // çµ±ä¸€ç©ºå€¼è™•ç†
});
```

### å¯¦ä½œå·®ç•°èªªæ˜

| è¦æ ¼ | å¯¦éš›å¯¦ä½œ | èªªæ˜ |
|------|----------|------|
| Vercel Functions | Express Server (`server.js`) | ç°¡åŒ–æœ¬åœ°é–‹ç™¼èˆ‡æ¸¬è©¦ |
| åˆ†é–‹çš„åŒ¯å‡ºç«¯é» | çµ±ä¸€ `/api/financial-basics/export` | ä¸€æ¬¡è¼¸å‡ºå…©å€‹ Sheet |
| ImportResultToast çµ„ä»¶ | æ•´åˆè‡³ ImportPreviewModal | ç°¡åŒ–çµ„ä»¶çµæ§‹ |
