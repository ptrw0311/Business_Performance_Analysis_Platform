# 提案：Excel 匯入/匯出功能

## Change ID
`import-export-excel`

## Why

### 現況問題
1. **手動輸入效率低**：現有系統僅支援單筆新增/編輯，大量資料輸入耗時
2. **資料來源多樣**：使用者經常從 Excel 收集財務資料，需要手動轉錄到系統
3. **批次操作需求**：多公司、多年度的資料更新需要批次處理能力
4. **資料備份與遷移**：缺乏便捷的資料匯出機制供備份或遷移使用

### 預期效益
1. **提升效率**：透過 Excel 批次匯入，大幅減少資料輸入時間
2. **降低錯誤**：減少手動輸入的人為錯誤
3. **靈活性**：使用者可離線編輯 Excel，再一次性匯入
4. **資料互通**：支援與其他系統的資料交換

## What Changes

在「數據與檔案管理」區塊新增 Excel 匯入/匯出功能，讓使用者可以透過 Excel 檔案批次匯入或匯出財務報表（financial_basics）和損益表（pl_income_basics）資料。

## 動機

### 現況問題
1. **手動輸入效率低**：現有系統僅支援單筆新增/編輯，大量資料輸入耗時
2. **資料來源多樣**：使用者經常從 Excel 收集財務資料，需要手動轉錄到系統
3. **批次操作需求**：多公司、多年度的資料更新需要批次處理能力
4. **資料備份與遷移**：缺乏便捷的資料匯出機制供備份或遷移使用

### 預期效益
1. **提升效率**：透過 Excel 批次匯入，大幅減少資料輸入時間
2. **降低錯誤**：減少手動輸入的人為錯誤
3. **靈活性**：使用者可離線編輯 Excel，再一次性匯入
4. **資料互通**：支援與其他系統的資料交換

## 設計方案

### Excel 檔案格式規範

#### Sheet 結構
Excel 檔案包含以下工作表：
- **財務報表** (financial_basics) - 80+ 欄位
- **損益表** (pl_income_basics) - 26 欄位
- (可選) **驗證機制** - 供參考，不處理

#### 欄位對應規則

Excel 檔案採用雙列標題格式：
- **第 1 列**：中文欄位名稱（對應 Supabase `column_description`）
- **第 2 列**：英文欄位名稱（對應 Supabase `column_name`）

欄位對應優先順序：
1. **主要規則**：以第 2 列的英文名稱直接對應 Supabase 的 `column_name`
2. **次要規則**：若第 2 列無法對應，以第 1 列的中文欄位名稱對應 Supabase 的 `column_description`

#### 檔名規則
匯出檔案命名格式：`財務資料_YYYYMMDD_HHMMSS.xlsx`
- 範例：`財務資料_20260202_143052.xlsx`

### 匯入邏輯

#### PK 判斷與 Upsert

| 表格 | Primary Key | 判斷邏輯 |
|------|-------------|----------|
| financial_basics | `[fiscal_year, tax_id]` | PK 存在 → UPDATE，不存在 → INSERT |
| pl_income_basics | `[fiscal_year, tax_id]` | PK 存在 → UPDATE，不存在 → INSERT |

#### 匯入流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Excel 匯入流程                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 使用者點擊「從 Excel 匯入」按鈕                              │
│     ↓                                                           │
│  2. 選擇本地 Excel 檔案 (.xlsx)                                  │
│     ↓                                                           │
│  3. 前端解析 Excel 結構                                          │
│     - 驗證 Sheet 名稱（財務報表、損益表）                         │
│     - 驗證欄位格式（第 1 列中文、第 2 列英文）                    │
│     ↓                                                           │
│  4. 欄位對應與驗證                                              │
│     - 以第 2 列英文名稱對應 column_name（主要）                   │
│     - 無法對應時以第 1 列中文名稱對應 column_description（次要）   │
│     - 紀錄無法對應的欄位                                         │
│     ↓                                                           │
│  5. 顯示匯入預覽                                                 │
│     - 顯示將新增/更新的筆數                                       │
│     - 顯示無法對應的欄位警告                                      │
│     - 確認後執行匯入                                             │
│     ↓                                                           │
│  6. 執行批次 Upsert                                              │
│     - 呼叫 API：POST /api/financial-basics/batch-import          │
│     - 呼叫 API：POST /api/pl-income/batch-import                 │
│     ↓                                                           │
│  7. 顯示匯入結果                                                 │
│     - 成功/失敗筆數                                              │
│     - 錯誤詳細資訊（如有）                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 錯誤處理

| 錯誤類型 | 處理方式 |
|----------|----------|
| 檔案格式錯誤 | 顯示錯誤訊息，不執行匯入 |
| 缺少必要欄位 (fiscal_year, tax_id) | 跳過該筆資料，記錄錯誤 |
| 欄位對應失敗 | 記錄警告，跳過該欄位 |
| 資料格式錯誤 | 跳過該筆資料，記錄錯誤 |
| API 錯誤 | 顯示錯誤訊息，支援重新嘗試 |

### 匯出邏輯

#### 匯出流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Excel 匯出流程                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 使用者選擇匯出範圍                                          │
│     - 全部資料                                                   │
│     - 篩選結果（依公司、年度）                                   │
│     ↓                                                           │
│  2. 呼叫 API 取得資料                                            │
│     - GET /api/financial-basics/export?filter=...                │
│     - GET /api/pl-income/export?filter=...                       │
│     ↓                                                           │
│  3. 後端生成 Excel 檔案                                          │
│     - 第 1 列：中文欄位名稱 (column_description)                  │
│     - 第 2 列：英文欄位名稱 (column_name)                         │
│     - 第 3 列起：資料內容                                         │
│     ↓                                                           │
│  4. 下載 Excel 檔案                                             │
│     - 檔名：財務資料_YYYYMMDD_HHMMSS.xlsx                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### Excel 輸出格式

```
┌──────────┬──────────┬────────────┬────────────┬──────────┬────────┐
│  年度    │ 統一編號  │  公司名稱   │ 會計科目   │ 現金及約  │   ...  │
│ fiscal_  │  tax_id  │company_name│account_item│cash_equi  │        │
│   year   │          │            │            │valents    │        │
├──────────┼──────────┼────────────┼────────────┼──────────┼────────┤
│   2024   │ 28497918 │  博弘雲端   │ 6997 博弘  │  720,946 │   ...  │
│   2024   │ 96979933 │ 中華電信    │ 2412 中華電│ 36,259M  │   ...  │
└──────────┴──────────┴────────────┴────────────┴──────────┴────────┘
```

### UI/UX 設計

#### 按鈕位置

在「數據與檔案管理」區塊的 Tab 列右側新增按鈕：

```
┌─────────────────────────────────────────────────────────────────┐
│  數據與檔案管理                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ [📊 財務報表] [💰 損益表]      [+ 新增] [📥 從Excel匯入] [📤 匯出Excel] │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ... 表格內容 ...                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 匯入預覽對話框

```
┌──────────────────────────────────────────────────────────────────┐
│  📥 Excel 匯入預覽                                     [×]       │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  檔案：財務資料_20260202.xlsx                                    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  📊 財務報表                                                │ │
│  │  ────────────────────────────────────────────────────────  │ │
│  │  將新增：12 筆                                               │ │
│  │  將更新：5 筆                                                │ │
│  │  跳過（PK 衝突）：0 筆                                       │ │
│  │  跳過（資料錯誤）：1 筆                                       │ │
│  │  ⚠️ 無法對應的欄位：無                                       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  💰 損益表                                                  │ │
│  │  ────────────────────────────────────────────────────────  │ │
│  │  將新增：12 筆                                               │ │
│  │  將更新：5 筆                                                │ │
│  │  跳過（PK 衝突）：0 筆                                       │ │
│  │  跳過（資料錯誤）：0 筆                                       │ │
│  │  ⚠️ 無法對應的欄位：無                                       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ⚠️ 警告：匯入將覆蓋現有資料，請確認後繼續                        │
│                                                                  │
│                                    [取消]            [確定匯入] │
└──────────────────────────────────────────────────────────────────┘
```

#### 匯入完成通知

```
┌──────────────────────────────────────────────────────────────────┐
│  ✅ 匯入完成                                              [×]    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  財務報表：成功 17 筆，失敗 0 筆                                  │
│  損益表：成功 17 筆，失敗 0 筆                                    │
│                                                                  │
│  [重新整理表格]                                                   │
│                                                                  │
│                                    [關閉]                        │
└──────────────────────────────────────────────────────────────────┘
```

## 影響範圍

### 修改的 Specs
- `data-layer` - 新增批次匯入/匯出 API 端點

### 新增的 Specs
- `excel-import-export` - Excel 匯入/匯出功能規範

### 修改的檔案

#### 前端
- `src/components/DataManagerTabs.jsx` - 新增匯入/匯出按鈕
- `src/pages/HomePage.jsx` - 新增匯入/匯出狀態管理

#### 後端（新增）
- `api/financial-basics/batch-import.js` - 財務報表批次匯入
- `api/financial-basics/export.js` - 財務報表匯出
- `api/pl-income/batch-import.js` - 損益表批次匯入
- `api/pl-income/export.js` - 損益表匯出

### 新增的檔案

#### 前端
- `src/components/ExcelImportButton.jsx` - Excel 匯入按鈕組件
- `src/components/ExcelExportButton.jsx` - Excel 匯出按鈕組件
- `src/components/ImportPreviewModal.jsx` - 匯入預覽對話框
- `src/utils/excelParser.js` - Excel 解析工具
- `src/utils/excelGenerator.js` - Excel 生成工具

## 技術實作細節

### 前端 Excel 處理

使用 **XLSX** 套件（已有依賴）處理 Excel 檔案：

```javascript
import * as XLSX from 'xlsx';

// 讀取 Excel
const workbook = XLSX.read(file, { type: 'array' });
const sheet = workbook.Sheets['財務報表'];
const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

// 欄位對應
const headersRow1 = data[0]; // 中文
const headersRow2 = data[1]; // 英文
const rows = data.slice(2);
```

### 後端 Excel 生成

使用 **ExcelJS** 套件生成帶有樣式的 Excel：

```bash
npm install exceljs
```

```javascript
import ExcelJS from 'exceljs';

const workbook = new ExcelJS.Workbook();
const sheet = workbook.addWorksheet('財務報表');

// 第 1 列：中文標題
sheet.addRow(columnDescriptions);
// 第 2 列：英文標題
sheet.addRow(columnNames);
// 資料列
data.forEach(row => sheet.addRow(row));
```

### API 端點設計

| 端點 | 方法 | 說明 |
|------|------|------|
| `/api/financial-basics/batch-import` | POST | 批次匯入財務報表 |
| `/api/financial-basics/export` | GET | 匯出財務報表為 Excel |
| `/api/pl-income/batch-import` | POST | 批次匯入損益表 |
| `/api/pl-income/export` | GET | 匯出損益表為 Excel |

### 批次匯入 Payload 格式

```json
{
  "records": [
    {
      "fiscal_year": 2024,
      "tax_id": "28497918",
      "company_name": "博弘雲端",
      "account_item": "6997 博弘",
      "cash_equivalents": 720946,
      ...
    }
  ],
  "options": {
    "upsert": true,
    "skipErrors": false
  }
}
```

## 測試計畫

### 測試案例

1. **正常匯入**
   - 全新資料（INSERT）
   - 已有資料（UPDATE）
   - 混合新增與更新

2. **邊界情況**
   - 空檔案
   - 只有標題列
   - 超大檔案（1000+ 筆）

3. **錯誤處理**
   - 缺少必要欄位
   - 欄位對應失敗
   - 資料格式錯誤
   - 檔案格式錯誤（非 .xlsx）

4. **匯出測試**
   - 全部資料匯出
   - 篩選後資料匯出
   - 欄位順序正確性
   - 中文顯示正確性

## 替代方案考慮

| 方案 | 優點 | 缺點 | 選擇 |
|------|------|------|------|
| 方案 A：前端處理 Excel | 簡單快速，無後端修改 | 檔案大小受限，錯誤處理較弱 | ❌ |
| 方案 B：後端處理 Excel | 支援大檔案，錯誤處理完整 | 需要後端修改，處理時間較長 | ✅ |
| 方案 C：混合處理 | 前端預覽，後端執行 | 實作複雜度高 | ❌ |

## 實作狀態

**狀態**: ✅ 已完成
**完成日期**: 2026-02-03

### 已完成項目
- [x] 前端 Excel 匯入/匯出組件
- [x] 後端批次匯入 API
- [x] 後端 Excel 匯出 API（統一端點，雙 Sheet）
- [x] 中文字串編碼修正（`raw: false` 選項）
- [x] 匯入成功自動重新整理頁面
- [x] 完整錯誤處理機制

### 實作調整
- **後端實作方式**: 使用 Express Server (`server.js`) 而非 Vercel Functions
- **匯出端點**: 統一使用 `/api/financial-basics/export`，同時輸出「財務報表」和「損益表」兩個 Sheet
- **編碼修正**: XLSX.js 解析時加入 `raw: false, defval: null` 選項確保中文正確顯示

## 相關連結

- 參考檔案：`financial_data_complete 2.2.xlsx`
- Supabase 資料表：`financial_basics`、`pl_income_basics`
- 備份資料表：`financial_basics_bk_20260202`、`pl_income_basics_bk_20260202`
